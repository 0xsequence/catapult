# Similar to "raw-sequence-universal-deployer-2" but it
# uses some extra logic, delivered as a create-contract action, that ensures that the top level call fails if the contract
# fails to deploy. This ensures that the gas estimation is accurate and the transaction won't silently fail with out of gas.
name: "sequence-universal-deployer-2"
type: "template"
description: "Deploy a contract using the Sequence Universal Deployer v2"

arguments:
  creationCode:
    type: "bytes"
    description: "The creation code of the contract to deploy"
  salt:
    type: "bytes32"
    description: "The salt for deployment"

returns:
  address:
    type: "address"
    description: "The address of the deployed contract"

setup:
  - type: "nano-universal-deployer"
    arguments:
      creationCode: "0x608060405234801561001057600080fd5b5061013d806100206000396000f3fe60806040526004361061001e5760003560e01c80639c4ae2d014610023575b600080fd5b6100cb6004803603604081101561003957600080fd5b81019060208101813564010000000081111561005457600080fd5b82018360208201111561006657600080fd5b8035906020019184600183028401116401000000008311171561008857600080fd5b91908080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525092955050913592506100cd915050565b005b60008183516020850134f56040805173ffffffffffffffffffffffffffffffffffffffff83168152905191925081900360200190a050505056fea264697066735822122033609f614f03931b92d88c309d698449bb77efcd517328d341fa4f923c5d8c7964736f6c63430007060033"

actions:
  - type: "assured-deployment"
    arguments:
      targetAddress:
        type: "compute-create2"
        arguments:
          deployerAddress: "0x8A5Bc19e22D6aD55a2c763B93A75d09F321fe764"
          salt: "{{salt}}"
          initCode: "{{creationCode}}"
      factoryAddress: "0x8A5Bc19e22D6aD55a2c763B93A75d09F321fe764"
      callData:
        type: "abi-encode"
        arguments:
          signature: "deploy(bytes,uint256)"
          values:
            - "{{creationCode}}"
            - "{{salt}}"


skip_condition:
  - type: "contract-exists"
    arguments:
      address:
        type: "compute-create2"
        arguments:
          deployerAddress: "0x8A5Bc19e22D6aD55a2c763B93A75d09F321fe764"
          salt: "{{salt}}"
          initCode: "{{creationCode}}"

outputs:
  address:
    type: "compute-create2"
    arguments:
      deployerAddress: "0x8A5Bc19e22D6aD55a2c763B93A75d09F321fe764"
      salt: "{{salt}}"
      initCode: "{{creationCode}}"